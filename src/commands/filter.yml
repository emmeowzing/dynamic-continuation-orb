description: |
  Filter the list of modules (directories) provided in the shared config to those that contain changes.
parameters:
  modules:
    description: Directories which should be built upon changes.
    type: string
  modules-filtered:
    description: Path to the file where the filtered list of modules is generated
    type: string
    default: /tmp/modules-filtered.txt
  force-all:
    description: Forcibly build all the modules
    type: boolean
    default: false
  default-branch:
    description: The default branch of the repository.
    type: string
    default: master
  wildmatch-version:
    description: Wildmatch package version to install. For available versions, check PyPI - https://pypi.org/project/wildmatch/#description
    type: string
    default: 0.2.6
  circle-token:
    description: Token to authenticate with CircleCI
    type: string
    default: $CIRCLE_TOKEN
  circle-organization:
    description: CircleCI organization to query with your API key.
    type: string
    default: $CIRCLE_ORGANIZATION
  root-config:
    description: Provides the ability to map root repository changes (./) to a config file name.
    type: string
    default: app
  reporting-window:
    description: The time window used to calculate summary metrics for the default branch of the repository.
    type: enum
    enum: [last-7-days, last-90-days, last-24-hours, last-30-days, last-60-days]
    default: last-90-days
  squash-merge-lookbehind:
    description: Number of commits back to compare against following squash merges.
    type: string
    default: "1"
  include-config-changes:
    description: Include CircleCI config changes (e.g., scripts.yml) while checking for changed modules.
    type: boolean
    default: true
  project-type:
    description: Can be either GitHub (gh) or BitBucket (bb).
    type: enum
    enum: [github, bitbucket]
    default: github
  cache:
    description: Whether or not to cache (i.e. you're calling these commands in your own job, not 'continue').
    type: boolean
    default: true
steps:
  - run:
      name: Generate changed modules
      environment:
        SH_CIRCLE_TOKEN: << parameters.circle-token >>
        SH_FORCE_ALL: << parameters.force-all >>
        SH_DEFAULT_BRANCH: << parameters.default-branch >>
        SH_PROJECT_TYPE: << parameters.project-type >>
        SH_CIRCLE_ORGANIZATION: << parameters.circle-organization >>
        SH_REPORTING_WINDOW: << parameters.reporting-window >>
        SH_MODULES: << parameters.modules >>
        SH_MODULES_FILTERED: << parameters.modules-filtered >>
        SH_WILDMATCH_VERSION: << parameters.wildmatch-version >>
        SH_ROOT_CONFIG: << parameters.root-config >>
        SH_SQUASH_MERGE_LOOKBEHIND: << parameters.squash-merge-lookbehind >>
        SH_INCLUDE_CONFIG_CHANGES: << parameters.include-config-changes >>
      command: << include(scripts/filter.sh) >>
  - when:
      condition: << parameters.cache >>
      steps:
        - save_cache:
            paths:
              - << parameters.modules-filtered >>
            key: modules-filtered-{{ .Environment.CIRCLE_WORKFLOW_ID }}
