description: |
  Merge modules' configs, if there are changed files in the directory, into an additional config under .circleci/ in the
  checked-out source,
parameters:
  modules-filtered:
    description: Path to the file for the list of the modules to build
    type: string
    default: /tmp/modules-filtered.txt
  root-config:
    description: Provides the ability to map root repository changes (./) to a config file name. Defaults to app.yml.
    type: string
    default: app
  continue-config:
    description: Path to the internally-used config for continuation
    type: string
    default: .circleci/continue-config.yml
  circle-organization:
    description: CircleCI organization to query with your API key.
    type: string
    default: $CIRCLE_ORGANIZATION
  project-type:
    description: Can be either GitHub (gh) or BitBucket (bb).
    type: enum
    enum: [github, bitbucket]
    default: github
  circle-token:
    description: Token to authenticate with CircleCI
    type: string
    default: $CIRCLE_TOKEN
  cache:
    description: Whether or not to cache (i.e. you're calling these commands in your own job, not 'extend').
    type: boolean
    default: true
steps:
  - when:
      condition: << parameters.cache >>
      steps:
        - restore_cache:
            key: modules-filtered-{{ .Environment.CIRCLE_WORKFLOW_ID }}
  - run:
      name: Merge configs
      command: |
        # If `modules` is unavailable, stop this job without continuation
        if [ ! -s "<< parameters.modules-filtered >>" ]
        then
            printf "Nothing to merge. Halting the job.\\n"
            circleci-agent step halt
            exit 0
        fi

        # Convert a list of dirs to a list of config files under .circleci/ for reduction.
        awk '{
            if ($0 ~ /^\.$/) {
                printf ".circleci/<< parameters.root-config >>.yml\n"
            } else {
                printf(".circleci/%s.yml\n", $0)
            }
        }' << parameters.modules-filtered >> > /tmp/$CIRCLE_WORKFLOW_ID.txt
        mv /tmp/$CIRCLE_WORKFLOW_ID.txt << parameters.modules-filtered >>

        # Upgrading to v4 of yq ~ https://github.com/mikefarah/yq/issues/674#issuecomment-780948792
        yq eval-all '. as $item ireduce ({}; . * $item )' "$(cat /tmp/modules-filtered.txt | awk NF | tr "\\n" " " | awk NF)" | tee "<< parameters.continue-config >>"
  - run:
      name: CircleCI config validate reduced config
      command: |
        circleci config validate << parameters.continue-config >> --org-slug << parameters.project-type >>/<< parameters.circle-organization >> --token << parameters.circle-token >> --skip-update-check
